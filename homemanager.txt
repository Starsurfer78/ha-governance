PRD – HA Governance Add-on v0.1

Status: Implementierungsbereit
Version: 0.1
Ziel: Stabile Governance-Schicht mit deklarativer Policy Engine (Post-Action Enforcement)

1. Produktdefinition

HA Governance v0.1 ist ein Home Assistant Add-on, das:

Einen globalen House Mode verwaltet (Hybrid: Derived + Manual Override)

Deklarative Policies auswertet

Policy-Verletzungen post-aktional korrigiert oder blockiert

Jede Enforcement-Entscheidung strukturiert loggt

Vollständig lokal und deterministisch arbeitet

Keine Zieloptimierung.
Keine Simulation.
Keine Lernmechanismen.

2. Scope (verbindlich)
Enthalten

Async Python Runtime

HA WebSocket Listener (state_changed)

In-Memory State Cache

Hybrid House Mode

Declarative Policy Loader (YAML)

Prioritätsbasierte Policy Evaluation

Post-Action Enforcement

Structured JSON Logging

Health Endpoint

Nicht enthalten

Multi-User

Goal Scoring

Simulation

Pre-Execution Blocking

UI

Sprachschnittstelle

ML/AI

Cloud

Trae darf keine Features außerhalb dieses Scopes implementieren.

3. Systemarchitektur
3.1 Laufzeit

Python 3.11+

asyncio Event Loop

aiohttp (HTTP)

websockets oder aiohttp WS

Docker Container (HA Add-on kompatibel)

3.2 Modulstruktur
app/
 ├── main.py
 ├── ha_client.py
 ├── state_cache.py
 ├── mode_controller.py
 ├── policy_engine.py
 ├── enforcement.py
 ├── logging_config.py
 └── health.py


Keine zusätzlichen Module ohne Notwendigkeit.

4. Funktionale Anforderungen
4.1 HA Integration
Anforderungen

Verbindung über HA WebSocket API

Subscription auf state_changed

Reconnect mit exponential backoff

Graceful shutdown (SIGTERM Handling)

Initialer State Sync via REST

Erfolgsbedingung

HA Neustart → Add-on reconnectet automatisch

Netzwerkunterbrechung → reconnect stabil

Kein Absturz bei Event-Flut

4.2 State Cache
Anforderungen

In-Memory Cache relevanter Entities

Async-safe Zugriff

Initialer Snapshot beim Start

Update bei jedem state_changed

Timestamp pro Entity

Optionale Staleness-Prüfung

Keine direkte HA-Abfrage in Business-Logik

Policy Engine darf nur auf StateCache zugreifen.

4.3 Hybrid House Mode
Entities

input_select.house_mode_override

AUTO

HOME

AWAY

NIGHT

WORK

sensor.house_mode_derived

sensor.house_mode_effective

Logik
if override != AUTO:
    effective_mode = override
else:
    effective_mode = derived_mode


Derived Mode basiert deterministisch auf:

Präsenz

Uhrzeit

Keine ML-Logik.

4.4 Declarative Policy Engine
Policy-Datei

YAML-basiert.

Minimalstruktur:

policies:
  - name: no_heating_when_window_open
    priority: 100
    when:
      window_open: true
      heating_active: true
    enforce:
      service: climate.set_hvac_mode
      target: climate.heating
      data:
        hvac_mode: "off"

Anforderungen

Policies müssen priorisiert sein

Sortierung nach priority (descending)

Deterministische Auswertung

Erste zutreffende Enforcement-Policy gewinnt

Maximal 5 Policies in v0.1.

4.5 Enforcement Layer
Modell

Post-Action Enforcement:

Event empfangen

Cache aktualisieren

Policies evaluieren

Verletzung erkannt

Service Call an HA

Log schreiben

Loop-Schutz

Jede Governor-Aktion markiert origin=governor

Folge-Events mit origin=governor werden nicht erneut korrigiert

Keine Endlosschleifen zulässig.

4.6 Logging

Structured JSON Logging.

Pflichtfelder:

{
  "timestamp": "...",
  "event_type": "policy_enforcement",
  "policy": "no_heating_when_window_open",
  "entity_id": "climate.heating",
  "previous_state": "heat",
  "new_state": "off",
  "effective_mode": "HOME",
  "origin": "governor"
}


Kein unstrukturiertes Print-Logging.

4.7 Health Endpoint

HTTP GET /health

Response:

{
  "status": "ok",
  "websocket_connected": true,
  "uptime_seconds": 1234
}

5. Nicht-Funktionale Anforderungen
5.1 Stabilität

Kein Blocking IO

Keine Memory-Leaks

Graceful Shutdown

Robust gegen HA Neustarts

5.2 Determinismus

Keine probabilistischen Entscheidungen

Keine impliziten Seiteneffekte

Keine versteckten States

5.3 Performance

Verarbeitung von 50+ Events/Sekunde ohne Crash

Keine CPU-Spikes > 80% dauerhaft

6. Definition of Done

v0.1 gilt als abgeschlossen, wenn:

Add-on läuft 7 Tage stabil

HA Neustarts werden überstanden

Keine Enforcement-Loops auftreten

Hybrid Mode korrekt funktioniert

Policies deterministisch greifen

Logs vollständig und strukturiert sind

Wenn einer dieser Punkte nicht erfüllt ist → v0.1 nicht abgeschlossen.

7. Explizite Verbote (Scope Guard)

Trae darf NICHT implementieren:

Goal Scoring

Simulation Engine

Multi-User

Pre-Execution Blocking

Adaptive Gewichtungen

UI

Voice

ML

„Vorbereitung für v0.2“

Jede zusätzliche Abstraktion muss begründet werden.

8. Erweiterbarkeit (implizit, nicht implementieren)

Die Architektur soll es ermöglichen, später:

GoalEvaluator hinzuzufügen

Simulator-Modul einzufügen

PolicyEngine zu erweitern

Aber v0.1 implementiert diese nicht.